import{m as fe,S as ve,t as G,e as D}from"./useBranding-C51QoB-t.js";import{ak as Ce,ah as be}from"./Validators-0vUS0OnA.js";import{C as ge}from"./Button-BNBtSKqQ.js";import{g as _e}from"./utils.esm-CMazHLgs.js";import{c as ee,i as te,b as W}from"./widget-DTIWWfiN.js";import{u as Ee}from"./vue-dompurify-html-CEAHYyWB.js";import{F as xe,z as ye}from"./index-DzK6ljgP.js";import{_ as V,H as ne,n as m,o as d,p as v,i as L,g as f,a as R,e as F,t as g,q as z,k as N,L as we,F as T,j as oe,r as C,M,c as b,w as Q,$ as X,A as H,x as A,l as Y,y as Re,m as Ae}from"./_plugin-vue_export-helper-n_vHXFlc.js";import{a as J,g as Z,c as $}from"./helper-BVTgYTlr.js";import{F as Fe}from"./module-WEXc1Yw_.js";import"./index-DN3rM4CW.js";import"./_commonjsHelpers-BosuxZz1.js";import"./sharedFrameEvents-0qZ2yOho.js";import"./constants-lVAyZKq6.js";import"./Icon-D1o1yyYK.js";import"./Branding-CCCFOlLc.js";const Pe={__name:"PhoneInput",props:{context:{type:Object,default:()=>({})}},setup(e,{expose:n}){n();const s=C(e.context.value||""),t=C(-1),a=C(!1),o=C(""),l=C(J()),c=C(Z()),h=C(""),p=M("dropdownRef"),i=M("searchbarRef"),E=b(()=>{var r,u;return((u=(r=e.context)==null?void 0:r.attrs)==null?void 0:u.placeholder)||""}),ae=b(()=>{var r,u;return(u=(r=e.context)==null?void 0:r.state)==null?void 0:u.invalid}),U=b(()=>l.value?"Clear selection":"Select Country"),P=b(()=>[{name:U.value,dial_code:"",emoji:"",id:""},...$]),x=b(()=>P.value.filter(r=>{const{name:u,dial_code:y,id:w}=r,_=o.value.toLowerCase();return u.toLowerCase().includes(_)||y.toLowerCase().includes(_)||w.toLowerCase().includes(_)})),re=b(()=>P.value.find(r=>r.id===l.value));Q(x,r=>{r.length<t.value+1&&(t.value=0)});function I(r){const u=X(r);s.value=`${u}${h.value}`,e.context.node.input(s.value)}function se(r){h.value=r.target.value,I(c.value)}function S(r){var u;return a.value?Array.from((u=p.value)==null?void 0:u.querySelectorAll(`div.country-dropdown div.country-dropdown--item.${r}`)):[]}function k(r){var y,w;const u=r;if(u.length>0){const _=p.value,de=_.clientHeight,me=(y=u[0])==null?void 0:y.offsetTop,he=(w=u[0])==null?void 0:w.offsetHeight,pe=me-de/2+he/2;_.scrollTo({top:pe,behavior:"auto"})}}function j(){H(()=>{k(S("focus"))})}function O(r){if(!a.value)return;const u=x.value.length-1;r==="up"?t.value=t.value<=0?u:t.value-1:r==="down"&&(t.value=t.value>=u?0:t.value+1),j()}function ie(){O("up")}function le(){O("down")}function B(){t.value=-1,a.value=!1}function q(r){l.value=r.id,o.value="",c.value=r.dial_code?r.dial_code:"",I(r.dial_code),B()}function ue(){a.value=!a.value,t.value=-1,a.value&&H(()=>{i.value.focus(),k(S("active"))})}function ce(){!a.value||t.value===-1||q(x.value[t.value])}const K={localValue:s,selectedIndex:t,showDropdown:a,searchCountry:o,activeCountryCode:l,activeDialCode:c,phoneNumber:h,dropdownRef:p,searchbarRef:i,placeholder:E,hasErrorInPhoneInput:ae,dropdownFirstItemName:U,countries:P,items:x,activeCountry:re,setContextValue:I,onChange:se,focusedOrActiveItem:S,scrollToFocusedOrActiveItem:k,adjustScroll:j,adjustSelection:O,moveSelectionUp:ie,moveSelectionDown:le,closeDropdown:B,onSelectCountry:q,toggleCountryDropdown:ue,onSelect:ce,ref:C,computed:b,watch:Q,useTemplateRef:M,nextTick:H,unref:X,get countriesList(){return $},FluentIcon:Fe,get getActiveCountryCode(){return J},get getActiveDialCode(){return Z}};return Object.defineProperty(K,"__isScriptSetup",{enumerable:!1,value:!0}),K}},Ie={class:"relative mt-2 phone-input--wrap"},Se={key:0,class:"mb-0 text-xl"},ke={key:0,class:"py-2 ltr:pl-2 rtl:pr-2 text-base text-n-slate-11"},Oe=["value","placeholder"],De={class:"sticky top-0 bg-n-background text-n-slate-12 dark:bg-n-solid-3"},Ne=["placeholder"],Me=["onClick"],He={key:0,class:"mr-2 text-xl"},Le={class:"text-sm leading-5 truncate"},Te={class:"ml-2 text-xs"},Ve={key:0},Ue={class:"flex justify-center mt-4 text-sm text-center text-n-slate-11"};function je(e,n,s,t,a,o){const l=ne("on-clickaway");return d(),m("div",Ie,[v("div",{class:z(["flex items-center justify-start outline-none phone-input rounded-lg box-border bg-n-background dark:bg-n-alpha-2 border-none outline outline-1 outline-offset-[-1px] text-sm w-full text-n-slate-12 focus-within:outline-n-brand focus-within:ring-1 focus-within:ring-n-brand",{"outline-n-ruby-8 dark:outline-n-ruby-8 hover:outline-n-ruby-9 dark:hover:outline-n-ruby-9":t.hasErrorInPhoneInput,"outline-n-weak":!t.hasErrorInPhoneInput}])},[v("div",{class:"flex items-center justify-between h-[2.625rem] px-2 py-2 cursor-pointer bg-n-alpha-1 dark:bg-n-solid-1 ltr:rounded-bl-lg rtl:rounded-br-lg ltr:rounded-tl-lg rtl:rounded-tr-lg min-w-[3.6rem] w-[3.6rem]",onClick:t.toggleCountryDropdown},[t.activeCountry.emoji?(d(),m("h5",Se,g(t.activeCountry.emoji),1)):(d(),R(t.FluentIcon,{key:1,icon:"globe",class:"fluent-icon",size:"20"})),F(t.FluentIcon,{icon:"chevron-down",class:"fluent-icon",size:"12"})]),t.activeDialCode?(d(),m("span",ke,g(t.activeDialCode),1)):f("v-if",!0),v("input",{value:t.phoneNumber,type:"phoneInput",class:"w-full h-full !py-3 pl-2 pr-3 leading-tight rounded-r !outline-none focus:!ring-0 !bg-transparent dark:!bg-transparent",name:"phoneNumber",placeholder:t.placeholder,onInput:t.onChange,onBlur:n[0]||(n[0]=(...c)=>s.context.blurHandler&&s.context.blurHandler(...c))},null,40,Oe)],2),t.showDropdown?L((d(),m("div",{key:0,ref:"dropdownRef",class:"country-dropdown absolute bg-n-background text-n-slate-12 dark:bg-n-solid-3 z-10 h-48 px-0 pt-0 pb-1 pl-1 pr-1 overflow-y-auto rounded-lg shadow-lg top-12 w-full min-w-24 max-w-[14.8rem]",onKeydown:[N(t.moveSelectionUp,["up"]),N(t.moveSelectionDown,["down"]),N(t.onSelect,["enter"])]},[v("div",De,[L(v("input",{ref:"searchbarRef","onUpdate:modelValue":n[1]||(n[1]=c=>t.searchCountry=c),type:"text",placeholder:e.$t("PRE_CHAT_FORM.FIELDS.PHONE_NUMBER.DROPDOWN_SEARCH"),class:"w-full h-8 !ring-0 px-3 py-2 mt-1 mb-1 text-sm rounded bg-n-alpha-black2"},null,8,Ne),[[we,t.searchCountry]])]),(d(!0),m(T,null,oe(t.items,(c,h)=>(d(),m("div",{key:h,class:z(["flex items-center h-8 px-2 py-2 rounded cursor-pointer country-dropdown--item text-n-slate-12 dark:hover:bg-n-solid-2 hover:bg-n-alpha-2",[c.id===t.activeCountryCode&&"active bg-n-alpha-1 dark:bg-n-solid-1",h===t.selectedIndex&&"focus dark:bg-n-solid-2 bg-n-alpha-2"]]),onClick:p=>t.onSelectCountry(c)},[c.emoji?(d(),m("span",He,g(c.emoji),1)):f("v-if",!0),v("span",Le,g(c.name),1),v("span",Te,g(c.dial_code),1)],10,Me))),128)),t.items.length===0?(d(),m("div",Ve,[v("span",Ue,g(e.$t("PRE_CHAT_FORM.FIELDS.PHONE_NUMBER.DROPDOWN_EMPTY")),1)])):f("v-if",!0)],32)),[[l,t.closeDropdown]]):f("v-if",!0)])}const Be=V(Pe,[["render",je],["__file","/app/app/javascript/widget/components/Form/PhoneInput.vue"]]),qe={components:{CustomButton:ge,Spinner:ve,FormKit:xe},mixins:[ee],props:{options:{type:Object,default:()=>{}}},emits:["submitPreChat"],setup(){const e=ye(Be,{props:["hasErrorInPhoneInput"]}),{formatMessage:n}=Ee();return{formatMessage:n,phoneInput:e}},data(){return{locale:this.$root.$i18n.locale,hasErrorInPhoneInput:!1,message:"",formValues:{},labels:{emailAddress:"EMAIL_ADDRESS",fullName:"FULL_NAME",phoneNumber:"PHONE_NUMBER"}}},computed:{...fe({widgetColor:"appConfig/getWidgetColor",isCreating:"conversation/getIsCreating",isConversationRouting:"appConfig/getIsUpdatingRoute",activeCampaign:"campaign/getActiveCampaign",currentUser:"contacts/getCurrentUser"}),isCreatingConversation(){return this.isCreating||this.isConversationRouting},textColor(){return _e(this.widgetColor)},hasActiveCampaign(){return!te(this.activeCampaign)},shouldShowHeaderMessage(){return this.hasActiveCampaign||this.preChatFormEnabled&&!!this.headerMessage},headerMessage(){return this.preChatFormEnabled?this.options.preChatMessage:this.hasActiveCampaign?this.$t("PRE_CHAT_FORM.CAMPAIGN_HEADER"):""},preChatFields(){return this.preChatFormEnabled?this.options.preChatFields:[]},filteredPreChatFields(){const e=this.currentUser.has_email,n=this.currentUser.has_phone_number,t=!!(!!this.currentUser.identifier||e||n);return this.preChatFields.filter(a=>!(e&&a.name==="emailAddress"||n&&a.name==="phoneNumber"||t&&a.name==="fullName"))},enabledPreChatFields(){return this.filteredPreChatFields.filter(e=>e.enabled).map(e=>({...e,type:e.name==="phoneNumber"?this.phoneInput:this.findFieldType(e.type)}))},conversationCustomAttributes(){let e={};return this.enabledPreChatFields.forEach(n=>{n.field_type==="conversation_attribute"&&(e={...e,[n.name]:this.getValue(n)})}),e},contactCustomAttributes(){let e={};return this.enabledPreChatFields.forEach(n=>{n.field_type==="contact_attribute"&&(e={...e,[n.name]:this.getValue(n)})}),e}},methods:{labelClass(e){const{state:n}=e.context;return n.invalid?"text-n-ruby-10":"text-n-slate-12"},inputClass(e){const{state:n,family:s,type:t}=e.context,a=n.invalid;return s==="box"&&t==="checkbox"?"":(t==="phoneInput"&&(this.hasErrorInPhoneInput=a),a?"mt-1 rounded w-full py-2 px-3 error":"mt-1 rounded w-full py-2 px-3")},isContactFieldRequired(e){return this.preChatFields.find(n=>n.name===e).required},getLabel({label:e}){return e},getPlaceHolder({placeholder:e}){return e},getValue({name:e,type:n}){return n==="select"?this.enabledPreChatFields.find(s=>s.name===e).values[this.formValues[e]]:this.formValues[e]||null},getValidation({type:e,name:n,field_type:s,regex_pattern:t}){let a=t?Ce(t):null;const o={emailAddress:"email",phoneNumber:["startsWithPlus","isValidPhoneNumber"],url:"url",date:"date",text:null,select:null,number:null,checkbox:!1,contact_attribute:a?[["matches",a]]:null,conversation_attribute:a?[["matches",a]]:null},l=Object.keys(o),h=this.isContactFieldRequired(n)?["required"]:["optional"];if(l.includes(n)||l.includes(e)||l.includes(s)){const p=o[e]||o[n]||o[s];return(p?h.concat(p):h).join("|")}return""},findFieldType(e){return e==="link"?"url":e==="list"?"select":e},getOptions(e){if(e.type==="select"){let n={};return e.values.forEach((s,t)=>{n={...n,[t]:s}}),n}return{}},onSubmit(){const{emailAddress:e,fullName:n,phoneNumber:s,message:t}=this.formValues;this.$emit("submitPreChat",{fullName:n,phoneNumber:s,emailAddress:e,message:t,activeCampaignId:this.activeCampaign.id,conversationCustomAttributes:this.conversationCustomAttributes,contactCustomAttributes:this.contactCustomAttributes})}}},Ke={key:0,class:"mb-4 text-base leading-5 text-n-slate-12 [&>p>.link]:text-n-blue-text [&>p>.link]:hover:underline"};function Ge(e,n,s,t,a,o){const l=A("FormKit"),c=A("Spinner"),h=A("CustomButton"),p=ne("dompurify-html");return d(),m(T,null,[f(" hide the default submit button for now "),F(l,{modelValue:a.formValues,"onUpdate:modelValue":n[0]||(n[0]=i=>a.formValues=i),type:"form","form-class":"flex flex-col flex-1 w-full p-6 overflow-y-auto","incomplete-message":!1,"submit-attrs":{inputClass:"hidden",wrapperClass:"hidden"},onSubmit:o.onSubmit},{default:Y(()=>[o.shouldShowHeaderMessage?L((d(),m("div",Ke,null,512)),[[p,t.formatMessage(o.headerMessage,!1)]]):f("v-if",!0),f(` Why do the v-bind shenanigan? Because Formkit API is really bad.
    If we just pass the options as is even with null or undefined or false,
    it assumes we are trying to make a multicheckbox. This is the best we have for now `),(d(!0),m(T,null,oe(o.enabledPreChatFields,i=>(d(),R(l,Re({key:i.name,name:i.name,type:i.type,label:o.getLabel(i),placeholder:o.getPlaceHolder(i),validation:o.getValidation(i),ref_for:!0},i.type==="select"?{options:o.getOptions(i)}:void 0,{"label-class":E=>`text-sm font-medium ${o.labelClass(E)}`,"input-class":E=>o.inputClass(E),"validation-messages":{startsWithPlus:e.$t("PRE_CHAT_FORM.FIELDS.PHONE_NUMBER.DIAL_CODE_VALID_ERROR"),isValidPhoneNumber:e.$t("PRE_CHAT_FORM.FIELDS.PHONE_NUMBER.VALID_ERROR"),email:e.$t("PRE_CHAT_FORM.FIELDS.EMAIL_ADDRESS.VALID_ERROR"),required:e.$t("PRE_CHAT_FORM.REQUIRED"),matches:i.regex_cue?i.regex_cue:e.$t("PRE_CHAT_FORM.REGEX_ERROR")},"has-error-in-phone-input":a.hasErrorInPhoneInput}),null,16,["name","type","label","placeholder","validation","label-class","input-class","validation-messages","has-error-in-phone-input"]))),128)),o.hasActiveCampaign?f("v-if",!0):(d(),R(l,{key:1,name:"message",type:"textarea","label-class":i=>`text-sm font-medium ${o.labelClass(i)}`,"input-class":i=>o.inputClass(i),label:e.$t("PRE_CHAT_FORM.FIELDS.MESSAGE.LABEL"),placeholder:e.$t("PRE_CHAT_FORM.FIELDS.MESSAGE.PLACEHOLDER"),validation:"required","validation-messages":{required:e.$t("PRE_CHAT_FORM.FIELDS.MESSAGE.ERROR")}},null,8,["label-class","input-class","label","placeholder","validation-messages"])),F(h,{class:"mt-3 mb-5 font-medium flex items-center justify-center gap-2",block:"","bg-color":e.widgetColor,"text-color":o.textColor,disabled:o.isCreatingConversation},{default:Y(()=>[o.isCreatingConversation?(d(),R(c,{key:0,class:"p-0"})):f("v-if",!0),Ae(" "+g(e.$t("START_CONVERSATION")),1)]),_:1},8,["bg-color","text-color","disabled"])]),_:1},8,["modelValue","onSubmit"])],2112)}const We=V(qe,[["render",Ge],["__file","/app/app/javascript/widget/components/PreChat/Form.vue"]]),ze={components:{PreChatForm:We},mixins:[ee],setup(){return{router:be()}},mounted(){D.on(W,this.handleConversationCreated)},beforeUnmount(){D.off(W,this.handleConversationCreated)},methods:{...G("conversation",["clearConversations"]),...G("conversationAttributes",["clearConversationAttributes"]),handleConversationCreated(){this.router.replace({name:"messages"})},onSubmit({fullName:e,emailAddress:n,message:s,activeCampaignId:t,phoneNumber:a,contactCustomAttributes:o,conversationCustomAttributes:l}){t?(D.emit("execute-campaign",{campaignId:t,customAttributes:l}),this.$store.dispatch("contacts/update",{user:{email:n,name:e,phone_number:a}})):(this.clearConversations(),this.clearConversationAttributes(),this.$store.dispatch("conversation/createConversation",{fullName:e,emailAddress:n,message:s,phoneNumber:a,customAttributes:l})),te(o)||this.$store.dispatch("contacts/setCustomAttributes",o)}}},Qe={class:"flex flex-1 overflow-auto"};function Xe(e,n,s,t,a,o){const l=A("PreChatForm",!0);return d(),m("div",Qe,[F(l,{options:e.preChatFormOptions,onSubmitPreChat:o.onSubmit},null,8,["options","onSubmitPreChat"])])}const mt=V(ze,[["render",Xe],["__file","/app/app/javascript/widget/views/PreChatForm.vue"]]);export{mt as default};
